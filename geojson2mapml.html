<html>
    <head>
        <script src="geojson2mapml_test_GeoJSON.js" ></script>
    </head> 
<body>
<script>

// Takes GeoJSON Properties to return an HTML table, helper function
//    for geoJsonObj2MapMl
// properties2Table: Str -> HTML Table
function properties2Table(json) {
    let table = document.createElement('table');

    // Creating a Table Header
    let thead = table.createTHead();
    let row = thead.insertRow();
    let th1 = document.createElement("th");
    let th2 = document.createElement("th");
    th1.appendChild(document.createTextNode("Property name"));
    th2.appendChild(document.createTextNode("Property value"));
    th1.setAttribute("role", "columnheader");
    th2.setAttribute("role", "columnheader");
    th1.setAttribute("scope", "col");
    th2.setAttribute("scope", "col");
    row.appendChild(th1);
    row.appendChild(th2);

    // Creating table body and populating it from the JSON
    let tbody = table.createTBody();
    for (let key in json) {
        if (json.hasOwnProperty(key)) {

            let row = tbody.insertRow();
            let th = document.createElement("th");
            let td = document.createElement("td");
            th.appendChild(document.createTextNode(key));
            td.appendChild(document.createTextNode(json[key]));
            th.setAttribute("scope", "row");
            td.setAttribute("itemprop", key);
            row.appendChild(th);
            row.appendChild(td);
        }
    }
    return table;
}



// Takes GeoJSON Objects and returns a <layer-> Element
// geoJsonObj2MapMl: GeoJSON-OBJ <layer-> -> <layer->
function geoJsonObj2MapMl(obj, MapML = null) {
    let geometryType = ["POINT", "LINESTRING", "POLYGON", "MULTIPOINT", "MULTILINESTRING", "MULTIPOLYGON", "GEOMETRYCOLLECTION"];
    let jsonType = obj.type.toUpperCase();
    let layer = MapML;
    let out = "";

    // HTML parser
    let parser = new DOMParser();

    // initializing layer
    if (layer == null) {
        // creating an empty mapml layer
        let xmlStringLayer = "<layer- label='' checked=''><map-meta name='projection' content='OSMTILE'></map-meta><map-meta name='cs' content='gcrs'></map-meta></layer->";
        layer = parser.parseFromString(xmlStringLayer, "text/html");
        //console.log(layer)
        if (obj.name) {
            layer.querySelector("layer-").setAttribute("label", obj.name);
        } else{
            layer.querySelector("layer-").setAttribute("label", "Layer");
        }
    }
    let xmlStringPoint = "<map-point></map-point>";
    let point = parser.parseFromString(xmlStringPoint, "text/html");

    let xmlStringMultiPoint = "<map-multipoint><map-coordinates></map-coordinates></map-multipoint>";
    let multiPoint = parser.parseFromString(xmlStringMultiPoint, "text/html");

    let xmlStringLinestring = "<map-linestring><map-coordinates></map-coordinates></map-linestring>";
    let linestring = parser.parseFromString(xmlStringLinestring, "text/html");

    let xmlStringmultilinestring = "<map-multilinestring></map-multilinestring>";
    let multilinestring = parser.parseFromString(xmlStringmultilinestring, "text/html");

    let xmlStringPolygon = "<map-polygon></map-polygon>";
    let polygon = parser.parseFromString(xmlStringPolygon, "text/html");

    let xmlStringMultiPolygon = "<map-multipolygon></map-multipolygon>";
    let multiPolygon = parser.parseFromString(xmlStringMultiPolygon, "text/html");

    let xmlStringgeometrycollection = "<map-geometrycollection></map-geometrycollection>";
    let geometrycollection = parser.parseFromString(xmlStringgeometrycollection, "text/html");

    let xmlStringFeature = "<map-feature class='child' zoom='2'><map-featurecaption></map-featurecaption><map-geometry></map-geometry><map-properties></map-properties></map-feature>";
    let feature = parser.parseFromString(xmlStringFeature, "text/html");

    // Template to add coordinates to Geometries
    let xmlStringCoords = "<map-coordinates></map-coordinates>";
    let coords = parser.parseFromString(xmlStringCoords, "text/html");
    
    //console.log(layer);
    if (jsonType === "FEATURECOLLECTION") {
        let features = obj.features;
        //console.log("Features length - " + features.length);
        for (l=0;l<features.length;l++) {
            geoJsonObj2MapMl(features[l], layer);
        }
    } else if (jsonType === "FEATURE") {

        let clone_feature = feature.cloneNode(true);
        let curr_feature = clone_feature.querySelector('map-feature');

        // Setting Properties
        let p = properties2Table(obj.properties);
        //console.log(p);
        curr_feature.querySelector('map-properties').appendChild(p);

        // Setting map-geometry
        let g = geoJsonObj2MapMl(obj.geometry, 1);
        //console.log(g);
        curr_feature.querySelector('map-geometry').appendChild(g);
        
        // Appending feature to layer
        layer.querySelector('layer-').appendChild(curr_feature);
        
    } else if (geometryType.includes(jsonType)) {
        console.log("Geometry Type - " + jsonType);
        switch(jsonType){
            case "POINT": // ---------------------------------------------------------------------------
                out = obj.coordinates[0] + " " + obj.coordinates[1];
                
                // Create Point element
                let clone_point = point.cloneNode(true);
                clone_point = clone_point.querySelector('map-point');

                // Create map-coords to add to the polygon
                let clone_coords = coords.cloneNode(true);
                clone_coords = clone_coords.querySelector("map-coordinates");

                clone_coords.innerHTML = out;

                clone_point.appendChild(clone_coords);
                //console.log(clone_point);
                return clone_point;

            case "LINESTRING": // ---------------------------------------------------------------------------
                let clone_linestring = linestring.cloneNode(true);
                let linestring_coordindates = clone_linestring.querySelector("map-coordinates");
                
                out = "";

                for (x=0;x<obj.coordinates.length;x++) {
                    out = out + obj.coordinates[x][0] + " " + obj.coordinates[x][1] + " ";
                }

                linestring_coordindates.innerHTML = out;
                //console.log(clone_linestring.querySelector('map-linestring'));
                return (clone_linestring.querySelector('map-linestring'));

            case "POLYGON": // ---------------------------------------------------------------------------
                let clone_polygon = polygon.cloneNode(true);
                clone_polygon = clone_polygon.querySelector("map-polygon");
                
                // Going over each coordinates
                for (y=0;y<obj.coordinates.length;y++) {
                    let out = "";
                    let clone_coords = coords.cloneNode(true);
                    clone_coords = clone_coords.querySelector("map-coordinates");

                    // Going over coordinates for the polygon
                    for (x=0;x<obj.coordinates[y].length;x++) {
                        out = out + obj.coordinates[y][x][0] + " " + obj.coordinates[y][x][1] + " ";
                    }

                    // Create map-coordinates element and append it to clone_polygon
                    clone_coords.innerHTML = out;

                    clone_polygon.appendChild(clone_coords);
                }
                //console.log(clone_polygon);
                return clone_polygon;

            case "MULTIPOINT": // ---------------------------------------------------------------------------
                out = "";
                // Create multipoint element
                let clone_multipoint = multiPoint.cloneNode(true);
                clone_multipoint = clone_multipoint.querySelector('map-multipoint');

                for (i=0;i<obj.coordinates.length;i++) {
                    out = out + obj.coordinates[i][0] + " " + obj.coordinates[i][1] + " ";
                }
                clone_multipoint.querySelector('map-coordinates').innerHTML = out;
                return clone_multipoint;

            case "MULTILINESTRING": // ---------------------------------------------------------------------------
                let clone_multilinestring = multilinestring.cloneNode(true);
                clone_multilinestring = clone_multilinestring.querySelector("map-multilinestring");

                for(i=0;i<obj.coordinates.length;i++) {
                    let out = "";
                    let clone_coords = coords.cloneNode(true);
                    clone_coords = clone_coords.querySelector("map-coordinates");
                    for(y=0;y<obj.coordinates[i].length;y++) {
                        out = out + obj.coordinates[i][y][0] + " " + obj.coordinates[i][y][1] + " ";
                    }
                    clone_coords.innerHTML = out
                    clone_multilinestring.appendChild(clone_coords);
                }
                return clone_multilinestring;

            case "MULTIPOLYGON": // ---------------------------------------------------------------------------
                let m = multiPolygon.cloneNode(true);
                m = m.querySelector('map-multiPolygon');

                // Going over each Polygon
                for (i=0;i<obj.coordinates.length;i++) {
                    let clone_polygon = polygon.cloneNode(true);
                    clone_polygon = clone_polygon.querySelector("map-polygon");
                    
                    // Going over each coordinates
                    for (y=0;y<obj.coordinates[i].length;y++) {
                        let out = "";
                        let clone_coords = coords.cloneNode(true);
                        clone_coords = clone_coords.querySelector("map-coordinates");

                        // Going over coordinates for the polygon
                        for (x=0;x<obj.coordinates[i][y].length;x++) {
                            out = out + obj.coordinates[i][y][x][0] + " " + obj.coordinates[i][y][x][1] + " ";
                        }

                        // Create map-coordinates element and append it to clone_polygon
                        clone_coords.innerHTML = out;

                        clone_polygon.appendChild(clone_coords);
                    }
                    m.appendChild(clone_polygon);
                }
                return m;
            case "GEOMETRYCOLLECTION": // ---------------------------------------------------------------------------
                let g = geometrycollection.cloneNode(true);
                g = g.querySelector('map-geometrycollection');
                //console.log(obj.geometries);
                for (i=0;i<obj.geometries.length;i++) {
                    let fg = geoJsonObj2MapMl(obj.geometries[i], 1);
                    g.appendChild(fg);
                }
                return g;
        }
    }
    return layer;
}

console.log(geoJsonObj2MapMl(geojson).querySelector('layer-'));
//console.log(geoJsonObj2MapMl(geojsonPolygon));
//console.log(geoJsonObj2MapMl(geojsonPolygonHoles));
//console.log(geoJsonObj2MapMl(geojsonPoint));
//console.log(geoJsonObj2MapMl(geojsonLineString));
//console.log(geoJsonObj2MapMl(Canada)); // MultiPolygon
//console.log(geoJsonObj2MapMl(geojsonMultiPoint));
//console.log(geoJsonObj2MapMl(geojsonMultiLineString));
//console.log(geoJsonObj2MapMl(geojsonGeometryCollection));
//console.log(geoJsonObj2MapMl(Lake).querySelector('layer-'));
//console.log(geoJsonObj2MapMl(Coastline).querySelector('layer-'));



//console.log(geoJson2MapMl("https://gist.githubusercontent.com/wavded/1200773/raw/e122cf709898c09758aecfef349964a8d73a83f3/sample.json"));
</script>
</body>
</html>
